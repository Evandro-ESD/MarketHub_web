<div class="tela-produtos-wrapper">
  <div class="header-bar">
    <h1>Gerenciar Produtos</h1>
    <div class="filtro-wrapper">
      <input type="text" placeholder="Buscar por nome..." [(ngModel)]="filtro" name="filtro" class="input-filtro" />
      <span class="total" *ngIf="produtosFiltrados.length">{{ produtosFiltrados.length }} itens</span>
    </div>
  </div>

  <div class="acoes-topo">
    <button type="button" class="btn-primario" (click)="abrirModal()">+ Cadastrar Produto</button>
  </div>

  <!-- Modal de cadastro/edição -->
  <div class="modal-backdrop" *ngIf="modalAberto" (click)="fecharModal()"></div>
  <div class="modal" *ngIf="modalAberto" role="dialog" aria-modal="true" aria-labelledby="tituloModal">
    <div class="modal-header">
      <h2 id="tituloModal">{{ produtoEditando ? 'Editar Produto' : 'Novo Produto' }}</h2>
      <button type="button" class="fechar" (click)="fecharModal()" aria-label="Fechar">×</button>
    </div>
    <form [formGroup]="formProduto" (ngSubmit)="submit()" class="form-produto" novalidate>
  <div class="form-group">
    <label>Nome do Produto</label>
    <input formControlName="nome_produto" type="text" />
    @if(formProduto.get('nome_produto')?.touched &&
    formProduto.get('nome_produto')?.invalid){
    <div class="error">
      @if(formProduto.get('nome_produto')?.errors?.['required']){
      <small>Nome obrigatório.</small>
      } @if(formProduto.get('nome_produto')?.errors?.['minlength']){
      <small>Mínimo 3 caracteres.</small>
      }
    </div>
    }
  </div>

  <div class="form-group">
    <label>Descrição</label>
    <textarea formControlName="descricao"></textarea>
    @if(formProduto.get('descricao')?.touched &&
    formProduto.get('descricao')?.invalid){
    <div class="error">
      <small>Descrição obrigatória.</small>
    </div>
    }
  </div>

  <div class="form-group">
    <label>Preço</label>
    <input formControlName="preco" type="number" step="0.01" />
    @if(formProduto.get('preco')?.touched && formProduto.get('preco')?.invalid){
    <div class="error">
      <small>Informe um preço válido.</small>
    </div>
    }
  </div>

  <div class="form-group">
    <label>Estoque</label>
    <input formControlName="estoque" type="number" />
    @if(formProduto.get('estoque')?.touched &&
    formProduto.get('estoque')?.invalid){
    <div class="error">
      <small>Informe o estoque.</small>
    </div>
    }
  </div>

  <!-- Imagem -->
  <div class="form-group imagem-group">
    <label for="foto">Imagem</label>
    <div class="upload-area" [class.has-preview]="previewImagem">
      <input
        type="file"
        id="foto"
        (change)="onFileChange($event)"
        accept=".jpg,.jpeg,.png,.gif"
      />
      <div class="preview" *ngIf="previewImagem">
        <img [src]="previewImagem" alt="Pré-visualização" />
        <button type="button" class="remover-foto" (click)="removerImagem()" aria-label="Remover imagem">×</button>
      </div>
      <span class="hint" *ngIf="!previewImagem">Selecione uma imagem (JPG/PNG)</span>
    </div>
    @if(formProduto.get('foto')?.touched && formProduto.get('foto')?.invalid){
      <div class="error"><small>Selecione uma imagem válida.</small></div>
    }
  </div>

      <div class="botoes-form">
        <button type="submit" [disabled]="formProduto.invalid">
          {{ produtoEditando ? 'Salvar Alterações' : 'Cadastrar' }}
        </button>
        <button type="button" (click)="cancelarEdicao()" *ngIf="produtoEditando" class="cancel-btn">Cancelar edição</button>
        <button type="button" class="btn-secundario" (click)="fecharModal()">Fechar</button>
      </div>
      @if(produtoEditando){
        <div class="editando-badge">Editando: {{ produtoEditando?.nome_produto }}</div>
      }
    </form>
  </div>

<hr />

<h2>Produtos cadastrados</h2>
<div class="empty" *ngIf="!loading && produtosFiltrados.length === 0">Nenhum produto encontrado.</div>
<div class="grid-produtos" [class.loading]="loading">
  <ng-container *ngIf="loading; else listaProdutos">
    <div class="skeleton-card" aria-hidden="true" *ngFor="let s of skeletons"></div>
  </ng-container>
  <ng-template #listaProdutos>
  <div class="card-produto" *ngFor="let produto of produtosFiltrados; trackBy: trackById" [class.editando]="produtoEditando?.id === produto.id">
    <div class="thumb-wrapper">
      <img *ngIf="produto.foto; else semFoto" [src]="produto.foto" alt="{{ produto.nome_produto }}" />
      <ng-template #semFoto>
        <div class="thumb-placeholder">SEM IMAGEM</div>
      </ng-template>
    </div>
    <div class="card-body">
      <h3>{{ produto.nome_produto }}</h3>
      <p class="descricao" [title]="produto.descricao">{{ produto.descricao }}</p>
      <div class="meta">
        <span class="preco">R$ {{ produto.preco | number:'1.2-2' }}</span>
        <span class="estoque" [class.low]="produto.estoque < 5">Estoque: {{ produto.estoque }}</span>
      </div>
    </div>
    <div class="acoes">
      <button type="button" (click)="editarProduto(produto)">Editar</button>
      <button type="button" class="excluir-btn" (click)="excluirProduto(produto.id)">Excluir</button>
    </div>
  </div>
  </ng-template>
</div>
</div>